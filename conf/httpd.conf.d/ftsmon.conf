<IfModule !ssl_module>
  LoadModule ssl_module modules/mod_ssl.so
</IfModule>
<IfModule !wsgi_module>
    LoadModule wsgi_module modules/mod_wsgi.so
</IfModule>
<IfModule !version_module>
    LoadModule version_module modules/mod_version.so
</IfModule>

# Monitoring in port 8449
Listen 8449
<VirtualHost *:8449>
    # SSL configuration
    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
    SSLEngine On

    # Certificates
    SSLCertificateFile /etc/grid-security/hostcert.pem
    SSLCertificateKeyFile /etc/grid-security/hostkey.pem
    SSLCACertificatePath /etc/grid-security/certificates

    # Client certificate by default is optional
    # The application will take care of more fine-grained authorization
    # If you want, you can add require in order to force a client certificate
    SSLVerifyClient optional
    SSLVerifyDepth  10
    SSLOptions +StdEnvVars

    # Mind that by default FTS3 Monitoring will require just a valid certificate
    # for every path, except for the server overview (so no robot certificate is required
    # by default for the Service Level feedback)
    # That's why optional is the default
    # If you want to do white-listing, have a look at this document
    # http://httpd.apache.org/docs/2.0/ssl/ssl_howto.html#certauthenticate

    # Django application
    WSGIScriptAlias /fts3 /usr/share/fts3web/fts3web.wsgi
    AllowEncodedSlashes On

    # Run in a separate process
    WSGIDaemonProcess fts3wmon processes=2 threads=10 maximum-requests=500 inactivity-timeout=60 display-name=fts3wmon
    WSGIProcessGroup fts3wmon

    <Location /fts3>
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Location>

    # Redirect to the monitoring webapp from the root
    RewriteEngine On
    RewriteRule ^/$ /fts3/ftsmon [R]
    RewriteRule ^/ftsmon/ /fts3/ftsmon [R]

    # Static content
    Alias /fts3/media /usr/share/fts3web/media
    <Location /media>
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>

        SetOutputFilter DEFLATE
        ExpiresActive On
        ExpiresDefault "access plus 1 month"
    </Location>

    # FTS3 logs
    Alias /var/log/fts3 /var/log/fts3
    <Directory /var/log/fts3>
        # This particular directory only server if a valid client certificate
        # was provided
        SSLVerifyClient require

        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
        SetOutputFilter DEFLATE
        ForceType text/plain
        Options +Indexes
    </Directory>
</VirtualHost>
